# 阶段三：待办项功能

## 目标

实现待办项的增删改查、分组分类、优先级标记等核心业务功能。

## 任务清单

### 3.1 创建 ViewModel

#### TodoItemViewModel.cs

```csharp
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using MiniNote.Models;
using System;

namespace MiniNote.ViewModels;

public partial class TodoItemViewModel : ObservableObject
{
    private readonly TodoItem _model;

    public TodoItemViewModel(TodoItem model)
    {
        _model = model;
    }

    public int Id => _model.Id;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(StrikethroughVisibility))]
    private bool _isCompleted;

    partial void OnIsCompletedChanged(bool value)
    {
        _model.IsCompleted = value;
        _model.UpdatedAt = DateTime.Now;
        CompletedChanged?.Invoke(this);
    }

    [ObservableProperty]
    private string _content = string.Empty;

    partial void OnContentChanged(string value)
    {
        _model.Content = value;
        _model.UpdatedAt = DateTime.Now;
    }

    [ObservableProperty]
    private int _priority;

    partial void OnPriorityChanged(int value)
    {
        _model.Priority = value;
    }

    [ObservableProperty]
    private DateTime? _reminderTime;

    partial void OnReminderTimeChanged(DateTime? value)
    {
        _model.ReminderTime = value;
    }

    [ObservableProperty]
    private string _categoryName = "默认";

    [ObservableProperty]
    private string _categoryColor = "#007ACC";

    public System.Windows.Visibility StrikethroughVisibility =>
        IsCompleted ? System.Windows.Visibility.Visible : System.Windows.Visibility.Collapsed;

    public string PriorityText => Priority switch
    {
        2 => "高",
        1 => "中",
        _ => "低"
    };

    public string PriorityColor => Priority switch
    {
        2 => "#FF5252",
        1 => "#FFC107",
        _ => "#4CAF50"
    };

    public TodoItem Model => _model;

    // 事件
    public event Action<TodoItemViewModel>? CompletedChanged;
    public event Action<TodoItemViewModel>? DeleteRequested;

    [RelayCommand]
    private void Delete()
    {
        DeleteRequested?.Invoke(this);
    }
}
```

#### MainViewModel.cs

```csharp
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using MiniNote.Models;
using MiniNote.Services;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;

namespace MiniNote.ViewModels;

public partial class MainViewModel : ObservableObject
{
    private readonly DatabaseService _dbService;

    public MainViewModel()
    {
        _dbService = new DatabaseService();
        TodoItems = new ObservableCollection<TodoItemViewModel>();
        Categories = new ObservableCollection<TodoCategory>();
    }

    [ObservableProperty]
    private ObservableCollection<TodoItemViewModel> _todoItems;

    [ObservableProperty]
    private ObservableCollection<TodoCategory> _categories;

    [ObservableProperty]
    private TodoCategory? _selectedCategory;

    [ObservableProperty]
    private string _newTodoContent = string.Empty;

    [ObservableProperty]
    private int _newTodoPriority = 1;

    [ObservableProperty]
    private bool _isLoading;

    [ObservableProperty]
    private int _completedCount;

    [ObservableProperty]
    private int _totalCount;

    public async Task InitializeAsync()
    {
        IsLoading = true;

        // 加载分类
        var categories = await _dbService.GetAllCategoriesAsync();
        Categories.Clear();
        foreach (var category in categories)
        {
            Categories.Add(category);
        }

        // 加载待办项
        await RefreshTodosAsync();

        IsLoading = false;
    }

    [RelayCommand]
    private async Task RefreshTodosAsync()
    {
        var todos = await _dbService.GetAllTodosAsync();
        
        TodoItems.Clear();
        foreach (var todo in todos)
        {
            var vm = CreateTodoViewModel(todo);
            TodoItems.Add(vm);
        }

        UpdateCounts();
    }

    [RelayCommand]
    private async Task AddTodoAsync()
    {
        if (string.IsNullOrWhiteSpace(NewTodoContent))
            return;

        var todo = new TodoItem
        {
            Content = NewTodoContent.Trim(),
            Priority = NewTodoPriority,
            CategoryId = SelectedCategory?.Id
        };

        await _dbService.AddTodoAsync(todo);
        
        // 加载分类信息
        todo.Category = SelectedCategory;
        
        var vm = CreateTodoViewModel(todo);
        TodoItems.Insert(0, vm);

        // 清空输入
        NewTodoContent = string.Empty;
        NewTodoPriority = 1;

        UpdateCounts();
    }

    [RelayCommand]
    private async Task DeleteTodoAsync(TodoItemViewModel? todoVm)
    {
        if (todoVm == null) return;

        await _dbService.DeleteTodoAsync(todoVm.Id);
        TodoItems.Remove(todoVm);

        UpdateCounts();
    }

    [RelayCommand]
    private async Task ToggleCompleteAsync(TodoItemViewModel? todoVm)
    {
        if (todoVm == null) return;

        todoVm.IsCompleted = !todoVm.IsCompleted;
        await _dbService.UpdateTodoAsync(todoVm.Model);

        UpdateCounts();
    }

    [RelayCommand]
    private async Task AddCategoryAsync(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return;

        var category = new TodoCategory
        {
            Name = name.Trim(),
            SortOrder = Categories.Count
        };

        await _dbService.AddCategoryAsync(category);
        Categories.Add(category);
    }

    [RelayCommand]
    private async Task ClearCompletedAsync()
    {
        var completedItems = TodoItems.Where(t => t.IsCompleted).ToList();
        
        foreach (var item in completedItems)
        {
            await _dbService.DeleteTodoAsync(item.Id);
            TodoItems.Remove(item);
        }

        UpdateCounts();
    }

    private TodoItemViewModel CreateTodoViewModel(TodoItem todo)
    {
        var vm = new TodoItemViewModel(todo)
        {
            IsCompleted = todo.IsCompleted,
            Content = todo.Content,
            Priority = todo.Priority,
            ReminderTime = todo.ReminderTime,
            CategoryName = todo.Category?.Name ?? "默认",
            CategoryColor = todo.Category?.Color ?? "#007ACC"
        };

        vm.CompletedChanged += async (sender) =>
        {
            await _dbService.UpdateTodoAsync(sender.Model);
            UpdateCounts();
        };

        vm.DeleteRequested += async (sender) =>
        {
            await DeleteTodoAsync(sender);
        };

        return vm;
    }

    private void UpdateCounts()
    {
        TotalCount = TodoItems.Count;
        CompletedCount = TodoItems.Count(t => t.IsCompleted);
    }
}
```

### 3.2 创建待办项视图

#### TodoItemView.xaml

```xml
<UserControl x:Class="MiniNote.Views.TodoItemView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:MiniNote.ViewModels">
    
    <Border x:Name="ItemBorder"
            Background="#20FFFFFF"
            CornerRadius="6"
            Margin="0,0,0,6"
            Padding="10,8">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <!-- 完成复选框 -->
            <CheckBox Grid.Column="0"
                      IsChecked="{Binding IsCompleted}"
                      VerticalAlignment="Center"
                      Margin="0,0,8,0">
                <CheckBox.Template>
                    <ControlTemplate TargetType="CheckBox">
                        <Border x:Name="border"
                                Width="20" Height="20"
                                CornerRadius="10"
                                BorderBrush="#60FFFFFF"
                                BorderThickness="2"
                                Background="Transparent">
                            <TextBlock x:Name="check"
                                       Text="&#xE73E;"
                                       FontFamily="Segoe MDL2 Assets"
                                       FontSize="12"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Visibility="Collapsed"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#4CAF50"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="#4CAF50"/>
                                <Setter TargetName="check" Property="Visibility" Value="Visible"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </CheckBox.Template>
            </CheckBox>
            
            <!-- 内容 -->
            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                <Grid>
                    <TextBlock Text="{Binding Content}"
                               Foreground="White"
                               FontSize="13"
                               TextWrapping="Wrap"/>
                    <!-- 删除线 -->
                    <Rectangle Height="1"
                               Fill="#80FFFFFF"
                               VerticalAlignment="Center"
                               Visibility="{Binding StrikethroughVisibility}"/>
                </Grid>
                
                <!-- 分类和提醒时间 -->
                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                    <Border Background="{Binding CategoryColor}"
                            CornerRadius="3"
                            Padding="6,2"
                            Visibility="{Binding CategoryName, Converter={StaticResource NullToVisibilityConverter}}">
                        <TextBlock Text="{Binding CategoryName}"
                                   Foreground="White"
                                   FontSize="10"/>
                    </Border>
                    
                    <TextBlock Text="{Binding ReminderTime, StringFormat='{}{0:MM/dd HH:mm}'}"
                               Foreground="#80FFFFFF"
                               FontSize="10"
                               Margin="8,0,0,0"
                               VerticalAlignment="Center"
                               Visibility="{Binding ReminderTime, Converter={StaticResource NullToVisibilityConverter}}"/>
                </StackPanel>
            </StackPanel>
            
            <!-- 优先级标记 -->
            <Border Grid.Column="2"
                    Width="6" Height="20"
                    CornerRadius="3"
                    Background="{Binding PriorityColor}"
                    VerticalAlignment="Center"
                    Margin="8,0"/>
            
            <!-- 删除按钮 -->
            <Button Grid.Column="3"
                    Content="&#xE74D;"
                    FontFamily="Segoe MDL2 Assets"
                    FontSize="12"
                    Foreground="#80FFFFFF"
                    Background="Transparent"
                    BorderThickness="0"
                    Cursor="Hand"
                    Command="{Binding DeleteCommand}"
                    Visibility="{Binding IsMouseOver, ElementName=ItemBorder, Converter={StaticResource BoolToVisibilityConverter}}"/>
        </Grid>
    </Border>
</UserControl>
```

### 3.3 创建待办列表视图

#### TodoListView.xaml

```xml
<UserControl x:Class="MiniNote.Views.TodoListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:views="clr-namespace:MiniNote.Views">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 添加区域 -->
        <Border Grid.Row="0"
                Background="#15FFFFFF"
                CornerRadius="6"
                Padding="8"
                Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBox x:Name="TxtNewTodo"
                         Text="{Binding NewTodoContent, UpdateSourceTrigger=PropertyChanged}"
                         Background="Transparent"
                         Foreground="White"
                         BorderThickness="0"
                         FontSize="13"
                         VerticalAlignment="Center"
                         CaretBrush="White">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding AddTodoCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>
                
                <!-- 占位符文本 -->
                <TextBlock Text="添加新待办..."
                           Foreground="#60FFFFFF"
                           FontSize="13"
                           VerticalAlignment="Center"
                           IsHitTestVisible="False"
                           Visibility="{Binding Text, ElementName=TxtNewTodo, Converter={StaticResource EmptyToVisibilityConverter}}"/>
                
                <Button Grid.Column="1"
                        Content="&#xE710;"
                        FontFamily="Segoe MDL2 Assets"
                        FontSize="14"
                        Foreground="White"
                        Background="#007ACC"
                        BorderThickness="0"
                        Padding="8,4"
                        Cursor="Hand"
                        Command="{Binding AddTodoCommand}">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="border"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="4"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="#1E90FF"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
            </Grid>
        </Border>
        
        <!-- 待办列表 -->
        <ScrollViewer Grid.Row="1"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding TodoItems}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <views:TodoItemView DataContext="{Binding}"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        
        <!-- 底部统计 -->
        <Border Grid.Row="2"
                Background="#10FFFFFF"
                CornerRadius="6"
                Padding="10,6"
                Margin="0,8,0,0">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Foreground="#80FFFFFF" FontSize="11">
                        <Run Text="已完成 "/>
                        <Run Text="{Binding CompletedCount}" Foreground="White"/>
                        <Run Text=" / "/>
                        <Run Text="{Binding TotalCount}"/>
                    </TextBlock>
                </StackPanel>
                
                <Button Content="清除已完成"
                        HorizontalAlignment="Right"
                        Foreground="#FF5252"
                        Background="Transparent"
                        BorderThickness="0"
                        FontSize="11"
                        Cursor="Hand"
                        Command="{Binding ClearCompletedCommand}"
                        Visibility="{Binding CompletedCount, Converter={StaticResource ZeroToCollapsedConverter}}"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
```

### 3.4 值转换器

#### Converters.cs

```csharp
using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace MiniNote.Converters;

public class BoolToVisibilityConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        return value is bool b && b ? Visibility.Visible : Visibility.Collapsed;
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        return value is Visibility v && v == Visibility.Visible;
    }
}

public class NullToVisibilityConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        return value != null ? Visibility.Visible : Visibility.Collapsed;
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}

public class EmptyToVisibilityConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        return string.IsNullOrEmpty(value as string) ? Visibility.Visible : Visibility.Collapsed;
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}

public class ZeroToCollapsedConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        if (value is int i)
        {
            return i > 0 ? Visibility.Visible : Visibility.Collapsed;
        }
        return Visibility.Collapsed;
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}
```

### 3.5 更新 App.xaml 添加转换器

```xml
<Application.Resources>
    <!-- 转换器 -->
    <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
    <converters:EmptyToVisibilityConverter x:Key="EmptyToVisibilityConverter"/>
    <converters:ZeroToCollapsedConverter x:Key="ZeroToCollapsedConverter"/>
    
    <!-- 其他样式... -->
</Application.Resources>
```

## 验收标准

- [ ] 能够添加新的待办项
- [ ] 能够勾选/取消完成待办项
- [ ] 完成的待办项显示删除线
- [ ] 能够删除待办项
- [ ] 能够设置待办项优先级
- [ ] 待办项按优先级和完成状态排序
- [ ] 显示已完成/总数统计
- [ ] 能够清除所有已完成项

## 注意事项

1. 使用 CommunityToolkit.Mvvm 简化 MVVM 实现
2. 所有数据变更都通过 DatabaseService 持久化
3. UI 更新通过 ObservableCollection 和 ObservableObject 自动触发
