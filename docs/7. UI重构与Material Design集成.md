# 阶段六：UI 重构与 Material Design 集成

> **开发状态：已完成**
> - MaterialDesignThemes 集成：已完成
> - 界面样式重构：已完成
> - 深浅主题切换：已完成
> - 数据库迁移服务：已完成
> - 编辑功能增强：已完成

## 目标

使用 MaterialDesignThemes UI 库重构应用界面，实现现代化的 Material Design 风格，并支持深浅主题切换。

## 任务清单

### 6.1 集成 MaterialDesignThemes

#### 添加 NuGet 包

```xml
<PackageReference Include="MaterialDesignThemes" Version="5.3.0" />
```

#### App.xaml 配置

```xml
<Application.Resources>
    <ResourceDictionary>
        <ResourceDictionary.MergedDictionaries>
            <materialDesign:BundledTheme BaseTheme="Dark" PrimaryColor="Blue" SecondaryColor="Teal" />
            <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesign2.Defaults.xaml" />
        </ResourceDictionary.MergedDictionaries>
        
        <!-- 应用自定义资源和样式 -->
    </ResourceDictionary>
</Application.Resources>
```

### 6.2 主题切换功能

#### AppSettings 添加主题设置

```csharp
/// <summary>
/// 是否使用深色主题
/// </summary>
public bool IsDarkTheme { get; set; } = true;
```

#### 主题切换实现

```csharp
private void TglDarkTheme_Changed(object sender, RoutedEventArgs e)
{
    var isDark = TglDarkTheme.IsChecked ?? true;
    _settings.IsDarkTheme = isDark;
    
    // 切换 Material Design 主题
    var paletteHelper = new PaletteHelper();
    var theme = paletteHelper.GetTheme();
    theme.SetBaseTheme(isDark ? BaseTheme.Dark : BaseTheme.Light);
    paletteHelper.SetTheme(theme);

    ThemeChanged?.Invoke(this, isDark);
    SettingsChanged?.Invoke(this, _settings);
}
```

### 6.3 数据库迁移服务

为支持版本升级时的表结构更新，创建数据库迁移服务：

#### DatabaseMigrationService.cs

```csharp
public static class DatabaseMigrationService
{
    public static void Migrate()
    {
        var dbPath = GetDbPath();
        if (!File.Exists(dbPath)) return;

        using var connection = new SqliteConnection($"Data Source={dbPath}");
        connection.Open();

        // 迁移版本 1: 添加 IsDarkTheme 列
        MigrateV1_AddIsDarkTheme(connection);
    }

    private static void MigrateV1_AddIsDarkTheme(SqliteConnection connection)
    {
        if (!ColumnExists(connection, "Settings", "IsDarkTheme"))
        {
            using var cmd = connection.CreateCommand();
            cmd.CommandText = "ALTER TABLE Settings ADD COLUMN IsDarkTheme INTEGER NOT NULL DEFAULT 1";
            cmd.ExecuteNonQuery();
        }
    }

    private static bool ColumnExists(SqliteConnection connection, string tableName, string columnName)
    {
        using var cmd = connection.CreateCommand();
        cmd.CommandText = $"PRAGMA table_info({tableName})";
        
        using var reader = cmd.ExecuteReader();
        while (reader.Read())
        {
            if (reader.GetString(1).Equals(columnName, StringComparison.OrdinalIgnoreCase))
                return true;
        }
        return false;
    }
}
```

### 6.4 新增对话框

#### AddTodoDialog

新增待办项对话框，包含：
- 内容输入
- 优先级选择（低/中/高）
- 提醒时间设置（快捷选项 + 自定义）

#### EditTodoDialog

编辑待办项对话框，包含：
- 内容修改
- 优先级修改
- 提醒时间修改
- 删除功能

#### ReminderDialog

独立的提醒设置对话框，替代原有的 Popup 方式。

### 6.5 待办项视图优化

#### TodoItemView 布局调整

- 复选框顶端对齐
- 优先级显示为 Tag 样式
- 提醒时间显示在优先级右边
- 移除悬浮删除按钮
- 双击支持编辑

#### 复选框样式

```xml
<Style x:Key="TodoCheckBoxStyle" TargetType="CheckBox">
    <Setter Property="Template">
        <Setter.Value>
            <ControlTemplate TargetType="CheckBox">
                <Border x:Name="border"
                        Width="22" Height="22"
                        CornerRadius="11"
                        BorderBrush="#50FFFFFF"
                        BorderThickness="2"
                        Background="Transparent">
                    <materialDesign:PackIcon x:Name="check"
                                             Kind="Check"
                                             Visibility="Collapsed"/>
                </Border>
                <ControlTemplate.Triggers>
                    <Trigger Property="IsChecked" Value="True">
                        <Setter TargetName="border" Property="Background" Value="#4CAF50"/>
                        <Setter TargetName="check" Property="Visibility" Value="Visible"/>
                    </Trigger>
                </ControlTemplate.Triggers>
            </ControlTemplate>
        </Setter.Value>
    </Setter>
</Style>
```

### 6.6 MainWindow 更新

- 使用 MaterialDesign PackIcon 替代字体图标
- 悬浮添加按钮（嵌入模式下隐藏）
- 移除标题栏待办计数显示
- 统一窗口样式（圆角、阴影、强调线）

## 文件变更清单

### 新增文件
- `Services/DatabaseMigrationService.cs` - 数据库迁移服务
- `Views/AddTodoDialog.xaml(.cs)` - 新增待办对话框
- `Views/EditTodoDialog.xaml(.cs)` - 编辑待办对话框
- `Views/ReminderDialog.xaml(.cs)` - 提醒设置对话框

### 修改文件
- `MiniNote.csproj` - 添加 MaterialDesignThemes 包引用
- `App.xaml` - 集成 Material Design 主题和资源
- `App.xaml.cs` - 添加数据库迁移调用
- `Models/AppSettings.cs` - 添加 IsDarkTheme 属性
- `Services/DatabaseService.cs` - 保存 IsDarkTheme 设置
- `Services/NotificationService.cs` - 修复并发问题
- `Views/MainWindow.xaml(.cs)` - 重构界面和逻辑
- `Views/SettingsWindow.xaml(.cs)` - 重构界面，添加主题切换
- `Views/TodoItemView.xaml(.cs)` - 重构布局和交互
- `ViewModels/TodoItemViewModel.cs` - 添加编辑事件

## 验收标准

- [x] MaterialDesignThemes 正常集成
- [x] 深浅主题可以切换
- [x] 数据库迁移正常工作
- [x] 新增待办对话框正常工作
- [x] 编辑待办对话框正常工作
- [x] 删除功能在编辑对话框中可用
- [x] 提醒时间可以在编辑时修改
- [x] 待办项布局正确显示
- [x] 复选框功能正常
- [x] 无 StackOverflow 等运行时错误

## 注意事项

1. MaterialDesignThemes 需要 .NET Framework 4.6.2 或 .NET Core 3.0 以上
2. 数据库迁移在应用启动时自动执行
3. 主题切换使用 PaletteHelper 实现实时切换
4. 复选框事件需要避免与 ViewModel 属性变更形成循环调用
