# 固定到桌面与缩放处理

## 目标
- 将窗口固定到桌面层（类似壁纸软件效果）
- 在桌面缩放（DPI 125%、150% 等）下保持位置与尺寸一致

## 核心方案
1. 使用 WorkerW/SHELLDLL_DefView 作为宿主窗口
2. 通过 HwndSource 承载 WPF 内容（避免直接 SetParent WPF Window 导致不可见）
3. 位置与尺寸从 WPF 的 DIP 转为像素后再创建宿主
4. 嵌入时切换到软件渲染，提升在桌面层的可见性

## 关键流程（对应 DesktopEmbedService）
1. 查找宿主窗口  
   - 向 Progman 发送 WM_SPAWN_WORKER 创建 WorkerW  
   - 优先选择包含 DefView 的 WorkerW  
   - 若仅发现无 DefView 的 WorkerW，则退回 SHELLDLL_DefView

2. 处理缩放（DPI）  
   - WPF 的 Window.Left/Top/Width/Height 为 DIP  
   - 使用 VisualTreeHelper.GetDpi(window) 获取 DpiScaleX/Y  
   - 计算像素坐标：
     - px = dip * DpiScaleX/Y

3. 创建嵌入宿主  
   - HwndSourceParameters.ParentWindow = 宿主窗口句柄  
   - WindowStyle = WS_CHILD | WS_VISIBLE  
   - 宽高使用像素值  
   - RootVisual 绑定到 MainWindow 的内容

4. 软件渲染  
   - RenderOptions.ProcessRenderMode = RenderMode.SoftwareOnly  
   - 解除嵌入时恢复渲染模式

## 缩放不受影响的要点
- 必须在嵌入前将 DIP 统一转换成像素
- 只用像素创建 HwndSource 的大小与位置
- WPF 内容布局使用 DIP（Measure/Arrange），避免二次缩放

## 相关实现位置
- DesktopEmbedService.cs  
  - GetDesktopWorkerW / FindShellDefView  
  - TryCreateEmbedHost  
  - RenderOptions.ProcessRenderMode  
  - DPI 转换日志

## 注意事项
- 若 WorkerW 无法创建，优先记录日志并回退到 SHELLDLL_DefView
- 嵌入后主窗口隐藏，解除嵌入时恢复内容与位置
- 若后续需要适配动态缩放，可监听 DisplaySettingsChanged 或 DpiChanged 重新计算
