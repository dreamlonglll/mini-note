# 阶段四：提醒通知功能

> **开发状态：已完成**

## 目标

实现 Windows Toast 通知和定时提醒功能，让用户能够设置待办项的提醒时间。

## 任务清单

### 4.1 通知服务

#### NotificationService.cs

```csharp
using Microsoft.Toolkit.Uwp.Notifications;
using MiniNote.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;

namespace MiniNote.Services;

/// <summary>
/// 通知服务 - 处理 Windows Toast 通知
/// </summary>
public class NotificationService : IDisposable
{
    private readonly DatabaseService _dbService;
    private CancellationTokenSource? _cts;
    private Task? _reminderTask;

    public NotificationService(DatabaseService dbService)
    {
        _dbService = dbService;
    }

    /// <summary>
    /// 启动提醒检查任务
    /// </summary>
    public void StartReminderService()
    {
        _cts = new CancellationTokenSource();
        _reminderTask = Task.Run(async () => await CheckRemindersLoop(_cts.Token));
    }

    /// <summary>
    /// 停止提醒检查任务
    /// </summary>
    public void StopReminderService()
    {
        _cts?.Cancel();
    }

    /// <summary>
    /// 循环检查需要提醒的待办项
    /// </summary>
    private async Task CheckRemindersLoop(CancellationToken token)
    {
        while (!token.IsCancellationRequested)
        {
            try
            {
                await CheckAndSendReminders();
                await Task.Delay(TimeSpan.FromSeconds(30), token); // 每30秒检查一次
            }
            catch (TaskCanceledException)
            {
                break;
            }
            catch (Exception)
            {
                // 记录错误但继续运行
            }
        }
    }

    /// <summary>
    /// 检查并发送提醒
    /// </summary>
    private async Task CheckAndSendReminders()
    {
        var todos = await _dbService.GetAllTodosAsync();
        var now = DateTime.Now;

        var dueReminders = todos
            .Where(t => !t.IsCompleted 
                        && !t.IsReminded 
                        && t.ReminderTime.HasValue 
                        && t.ReminderTime.Value <= now)
            .ToList();

        foreach (var todo in dueReminders)
        {
            SendToastNotification(todo);
            
            // 标记为已提醒
            todo.IsReminded = true;
            await _dbService.UpdateTodoAsync(todo);
        }
    }

    /// <summary>
    /// 发送 Toast 通知
    /// </summary>
    public void SendToastNotification(TodoItem todo)
    {
        try
        {
            var builder = new ToastContentBuilder()
                .AddArgument("action", "viewTodo")
                .AddArgument("todoId", todo.Id.ToString())
                .AddText("MiniNote 提醒")
                .AddText(todo.Content);

            // 添加优先级信息
            string priorityText = todo.Priority switch
            {
                2 => "高优先级",
                1 => "中优先级",
                _ => "低优先级"
            };
            builder.AddText(priorityText);

            // 添加操作按钮
            builder.AddButton(new ToastButton()
                .SetContent("标记完成")
                .AddArgument("action", "complete")
                .AddArgument("todoId", todo.Id.ToString()));

            builder.AddButton(new ToastButton()
                .SetContent("稍后提醒")
                .AddArgument("action", "snooze")
                .AddArgument("todoId", todo.Id.ToString()));

            builder.Show();
        }
        catch (Exception)
        {
            // 通知发送失败时静默处理
        }
    }

    /// <summary>
    /// 发送简单通知
    /// </summary>
    public void SendSimpleNotification(string title, string message)
    {
        try
        {
            new ToastContentBuilder()
                .AddText(title)
                .AddText(message)
                .Show();
        }
        catch
        {
            // 静默处理
        }
    }

    /// <summary>
    /// 清除所有通知
    /// </summary>
    public void ClearAllNotifications()
    {
        try
        {
            ToastNotificationManagerCompat.History.Clear();
        }
        catch
        {
            // 静默处理
        }
    }

    public void Dispose()
    {
        StopReminderService();
        _cts?.Dispose();
    }
}
```

### 4.2 通知激活处理

#### App.xaml.cs 更新

```csharp
using Microsoft.Toolkit.Uwp.Notifications;
using MiniNote.Services;
using System.Windows;

namespace MiniNote;

public partial class App : Application
{
    private NotificationService? _notificationService;

    protected override void OnStartup(StartupEventArgs e)
    {
        base.OnStartup(e);

        // 注册通知激活处理
        ToastNotificationManagerCompat.OnActivated += OnToastActivated;

        // 如果是从通知启动的
        if (ToastNotificationManagerCompat.WasCurrentProcessToastActivated())
        {
            // 处理通知点击
            return;
        }
    }

    private void OnToastActivated(ToastNotificationActivatedEventArgsCompat e)
    {
        // 解析参数
        var args = ToastArguments.Parse(e.Argument);

        Application.Current.Dispatcher.Invoke(async () =>
        {
            var action = args.GetValueOrDefault("action", "");
            var todoIdStr = args.GetValueOrDefault("todoId", "");

            if (int.TryParse(todoIdStr, out int todoId))
            {
                var dbService = new DatabaseService();

                switch (action)
                {
                    case "complete":
                        // 标记完成
                        var todo = await dbService.GetTodoByIdAsync(todoId);
                        if (todo != null)
                        {
                            todo.IsCompleted = true;
                            await dbService.UpdateTodoAsync(todo);
                        }
                        break;

                    case "snooze":
                        // 稍后提醒（延后15分钟）
                        var snoozeTodo = await dbService.GetTodoByIdAsync(todoId);
                        if (snoozeTodo != null)
                        {
                            snoozeTodo.ReminderTime = DateTime.Now.AddMinutes(15);
                            snoozeTodo.IsReminded = false;
                            await dbService.UpdateTodoAsync(snoozeTodo);
                        }
                        break;

                    case "viewTodo":
                        // 显示主窗口
                        var mainWindow = Application.Current.MainWindow;
                        if (mainWindow != null)
                        {
                            mainWindow.Show();
                            mainWindow.Activate();
                        }
                        break;
                }
            }
        });
    }

    protected override void OnExit(ExitEventArgs e)
    {
        // 清理通知
        ToastNotificationManagerCompat.Uninstall();
        base.OnExit(e);
    }
}
```

### 4.3 添加提醒时间选择器

#### ReminderPicker.xaml

```xml
<UserControl x:Class="MiniNote.Views.ReminderPicker"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <Border Background="#20FFFFFF"
            CornerRadius="6"
            Padding="12">
        <StackPanel>
            <TextBlock Text="设置提醒"
                       Foreground="White"
                       FontWeight="SemiBold"
                       FontSize="14"
                       Margin="0,0,0,12"/>
            
            <!-- 快捷选项 -->
            <WrapPanel Margin="0,0,0,12">
                <Button Content="30分钟后"
                        Style="{StaticResource QuickReminderButtonStyle}"
                        Click="SetReminder_Click"
                        Tag="30"/>
                <Button Content="1小时后"
                        Style="{StaticResource QuickReminderButtonStyle}"
                        Click="SetReminder_Click"
                        Tag="60"/>
                <Button Content="3小时后"
                        Style="{StaticResource QuickReminderButtonStyle}"
                        Click="SetReminder_Click"
                        Tag="180"/>
                <Button Content="明天"
                        Style="{StaticResource QuickReminderButtonStyle}"
                        Click="SetReminder_Click"
                        Tag="tomorrow"/>
            </WrapPanel>
            
            <!-- 自定义时间 -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Margin="0,0,6,0">
                    <TextBlock Text="日期"
                               Foreground="#80FFFFFF"
                               FontSize="11"
                               Margin="0,0,0,4"/>
                    <DatePicker x:Name="DatePickerControl"
                                SelectedDate="{Binding SelectedDate}"
                                Background="#30FFFFFF"
                                Foreground="White"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Margin="6,0,0,0">
                    <TextBlock Text="时间"
                               Foreground="#80FFFFFF"
                               FontSize="11"
                               Margin="0,0,0,4"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBox x:Name="TxtHour"
                                 Text="{Binding Hour, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#30FFFFFF"
                                 Foreground="White"
                                 BorderThickness="0"
                                 TextAlignment="Center"
                                 MaxLength="2"/>
                        <TextBlock Grid.Column="1"
                                   Text=":"
                                   Foreground="White"
                                   VerticalAlignment="Center"
                                   Margin="4,0"/>
                        <TextBox Grid.Column="2"
                                 x:Name="TxtMinute"
                                 Text="{Binding Minute, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#30FFFFFF"
                                 Foreground="White"
                                 BorderThickness="0"
                                 TextAlignment="Center"
                                 MaxLength="2"/>
                    </Grid>
                </StackPanel>
            </Grid>
            
            <!-- 操作按钮 -->
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,12,0,0">
                <Button Content="取消"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Click="Cancel_Click"
                        Margin="0,0,8,0"/>
                <Button Content="确定"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Click="Confirm_Click"/>
            </StackPanel>
        </StackPanel>
    </Border>
</UserControl>
```

#### ReminderPicker.xaml.cs

```csharp
using System;
using System.Windows;
using System.Windows.Controls;

namespace MiniNote.Views;

public partial class ReminderPicker : UserControl
{
    public event EventHandler<DateTime?>? ReminderSelected;
    public event EventHandler? Cancelled;

    public DateTime SelectedDate { get; set; } = DateTime.Today;
    public int Hour { get; set; } = DateTime.Now.Hour;
    public int Minute { get; set; } = 0;

    public ReminderPicker()
    {
        InitializeComponent();
        DataContext = this;
    }

    private void SetReminder_Click(object sender, RoutedEventArgs e)
    {
        if (sender is Button btn && btn.Tag != null)
        {
            DateTime reminderTime;
            var tag = btn.Tag.ToString();

            if (tag == "tomorrow")
            {
                reminderTime = DateTime.Today.AddDays(1).AddHours(9); // 明天早上9点
            }
            else if (int.TryParse(tag, out int minutes))
            {
                reminderTime = DateTime.Now.AddMinutes(minutes);
            }
            else
            {
                return;
            }

            ReminderSelected?.Invoke(this, reminderTime);
        }
    }

    private void Cancel_Click(object sender, RoutedEventArgs e)
    {
        Cancelled?.Invoke(this, EventArgs.Empty);
    }

    private void Confirm_Click(object sender, RoutedEventArgs e)
    {
        var reminderTime = SelectedDate.Date.AddHours(Hour).AddMinutes(Minute);
        
        if (reminderTime <= DateTime.Now)
        {
            MessageBox.Show("提醒时间必须在当前时间之后", "提示", 
                MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        ReminderSelected?.Invoke(this, reminderTime);
    }
}
```

### 4.4 更新 MainViewModel 添加提醒功能

```csharp
// 添加到 MainViewModel.cs

[RelayCommand]
private async Task SetReminderAsync(TodoItemViewModel? todoVm)
{
    if (todoVm == null || !todoVm.ReminderTime.HasValue)
        return;

    todoVm.Model.ReminderTime = todoVm.ReminderTime;
    todoVm.Model.IsReminded = false;
    await _dbService.UpdateTodoAsync(todoVm.Model);
}

[RelayCommand]
private async Task ClearReminderAsync(TodoItemViewModel? todoVm)
{
    if (todoVm == null) return;

    todoVm.ReminderTime = null;
    todoVm.Model.ReminderTime = null;
    await _dbService.UpdateTodoAsync(todoVm.Model);
}
```

### 4.5 按钮样式

添加到 App.xaml：

```xml
<!-- 快捷提醒按钮样式 -->
<Style x:Key="QuickReminderButtonStyle" TargetType="Button">
    <Setter Property="Background" Value="#30FFFFFF"/>
    <Setter Property="Foreground" Value="White"/>
    <Setter Property="BorderThickness" Value="0"/>
    <Setter Property="Padding" Value="12,6"/>
    <Setter Property="Margin" Value="0,0,6,6"/>
    <Setter Property="FontSize" Value="11"/>
    <Setter Property="Cursor" Value="Hand"/>
    <Setter Property="Template">
        <Setter.Value>
            <ControlTemplate TargetType="Button">
                <Border x:Name="border"
                        Background="{TemplateBinding Background}"
                        CornerRadius="4"
                        Padding="{TemplateBinding Padding}">
                    <ContentPresenter HorizontalAlignment="Center"
                                      VerticalAlignment="Center"/>
                </Border>
                <ControlTemplate.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter TargetName="border" Property="Background" Value="#50FFFFFF"/>
                    </Trigger>
                </ControlTemplate.Triggers>
            </ControlTemplate>
        </Setter.Value>
    </Setter>
</Style>

<!-- 主要按钮样式 -->
<Style x:Key="PrimaryButtonStyle" TargetType="Button">
    <Setter Property="Background" Value="#007ACC"/>
    <Setter Property="Foreground" Value="White"/>
    <Setter Property="BorderThickness" Value="0"/>
    <Setter Property="Padding" Value="16,6"/>
    <Setter Property="FontSize" Value="12"/>
    <Setter Property="Cursor" Value="Hand"/>
    <Setter Property="Template">
        <Setter.Value>
            <ControlTemplate TargetType="Button">
                <Border x:Name="border"
                        Background="{TemplateBinding Background}"
                        CornerRadius="4"
                        Padding="{TemplateBinding Padding}">
                    <ContentPresenter HorizontalAlignment="Center"
                                      VerticalAlignment="Center"/>
                </Border>
                <ControlTemplate.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter TargetName="border" Property="Background" Value="#1E90FF"/>
                    </Trigger>
                </ControlTemplate.Triggers>
            </ControlTemplate>
        </Setter.Value>
    </Setter>
</Style>

<!-- 次要按钮样式 -->
<Style x:Key="SecondaryButtonStyle" TargetType="Button">
    <Setter Property="Background" Value="Transparent"/>
    <Setter Property="Foreground" Value="#80FFFFFF"/>
    <Setter Property="BorderThickness" Value="1"/>
    <Setter Property="BorderBrush" Value="#40FFFFFF"/>
    <Setter Property="Padding" Value="16,6"/>
    <Setter Property="FontSize" Value="12"/>
    <Setter Property="Cursor" Value="Hand"/>
    <Setter Property="Template">
        <Setter.Value>
            <ControlTemplate TargetType="Button">
                <Border x:Name="border"
                        Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="{TemplateBinding BorderThickness}"
                        CornerRadius="4"
                        Padding="{TemplateBinding Padding}">
                    <ContentPresenter HorizontalAlignment="Center"
                                      VerticalAlignment="Center"/>
                </Border>
                <ControlTemplate.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter TargetName="border" Property="Background" Value="#20FFFFFF"/>
                    </Trigger>
                </ControlTemplate.Triggers>
            </ControlTemplate>
        </Setter.Value>
    </Setter>
</Style>
```

## 验收标准

- [x] 能够为待办项设置提醒时间
- [x] 到达提醒时间时显示 Windows Toast 通知
- [x] 点击通知能打开应用
- [x] 通知中的"标记完成"按钮能正常工作
- [x] "稍后提醒"能延后15分钟再次提醒
- [ ] 应用关闭后提醒功能仍然工作（需要系统任务计划或后台服务支持）

## 注意事项

1. 需要在项目中添加 `<PackageReference Include="Microsoft.Toolkit.Uwp.Notifications" />`
2. Toast 通知需要应用有有效的应用标识（AUMID）
3. 提醒检查间隔为30秒，可根据需要调整
4. 应用关闭后提醒功能需要结合系统任务计划或后台服务实现
