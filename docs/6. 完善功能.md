# 阶段五：完善功能

> **开发状态：部分完成**
> - 系统托盘图标：已完成
> - 开机自启动服务：未开始
> - 设置窗口：未开始
> - 动画效果：未开始

## 目标

实现开机自启动、系统托盘图标、UI 动画美化等完善功能。

## 任务清单

### 5.1 开机自启动服务

#### AutoStartService.cs

```csharp
using Microsoft.Win32;
using System;
using System.Reflection;

namespace MiniNote.Services;

/// <summary>
/// 开机自启动服务
/// </summary>
public static class AutoStartService
{
    private const string AppName = "MiniNote";
    private const string RegistryKeyPath = @"SOFTWARE\Microsoft\Windows\CurrentVersion\Run";

    /// <summary>
    /// 检查是否已设置开机自启
    /// </summary>
    public static bool IsAutoStartEnabled()
    {
        try
        {
            using var key = Registry.CurrentUser.OpenSubKey(RegistryKeyPath, false);
            var value = key?.GetValue(AppName);
            return value != null;
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// 启用开机自启
    /// </summary>
    public static bool EnableAutoStart()
    {
        try
        {
            var exePath = GetExecutablePath();
            using var key = Registry.CurrentUser.OpenSubKey(RegistryKeyPath, true);
            key?.SetValue(AppName, $"\"{exePath}\" --startup");
            return true;
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// 禁用开机自启
    /// </summary>
    public static bool DisableAutoStart()
    {
        try
        {
            using var key = Registry.CurrentUser.OpenSubKey(RegistryKeyPath, true);
            key?.DeleteValue(AppName, false);
            return true;
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// 切换开机自启状态
    /// </summary>
    public static bool ToggleAutoStart()
    {
        if (IsAutoStartEnabled())
        {
            return DisableAutoStart();
        }
        else
        {
            return EnableAutoStart();
        }
    }

    private static string GetExecutablePath()
    {
        return Environment.ProcessPath ?? Assembly.GetExecutingAssembly().Location;
    }
}
```

### 5.2 系统托盘服务

#### TrayIconService.cs

```csharp
using System;
using System.Drawing;
using System.IO;
using System.Windows.Forms;
using MiniNote.Models;
using Application = System.Windows.Application;

namespace MiniNote.Services;

/// <summary>
/// 系统托盘图标服务
/// </summary>
public class TrayIconService : IDisposable
{
    private NotifyIcon? _notifyIcon;
    private ContextMenuStrip? _contextMenu;
    
    public event EventHandler? ShowWindowRequested;
    public event EventHandler? ExitRequested;
    public event EventHandler<bool>? AutoStartChanged;
    public event EventHandler<bool>? EmbedDesktopChanged;

    public void Initialize()
    {
        // 创建托盘图标
        _notifyIcon = new NotifyIcon
        {
            Icon = LoadIcon(),
            Text = "MiniNote - 桌面待办",
            Visible = true
        };

        // 双击打开主窗口
        _notifyIcon.DoubleClick += (s, e) => ShowWindowRequested?.Invoke(this, EventArgs.Empty);

        // 创建右键菜单
        CreateContextMenu();
        _notifyIcon.ContextMenuStrip = _contextMenu;
    }

    private void CreateContextMenu()
    {
        _contextMenu = new ContextMenuStrip();

        // 显示主窗口
        var showItem = new ToolStripMenuItem("显示窗口");
        showItem.Click += (s, e) => ShowWindowRequested?.Invoke(this, EventArgs.Empty);
        _contextMenu.Items.Add(showItem);

        _contextMenu.Items.Add(new ToolStripSeparator());

        // 开机自启
        var autoStartItem = new ToolStripMenuItem("开机自启")
        {
            Checked = AutoStartService.IsAutoStartEnabled()
        };
        autoStartItem.Click += (s, e) =>
        {
            var enabled = AutoStartService.ToggleAutoStart();
            autoStartItem.Checked = AutoStartService.IsAutoStartEnabled();
            AutoStartChanged?.Invoke(this, autoStartItem.Checked);
        };
        _contextMenu.Items.Add(autoStartItem);

        // 嵌入桌面
        var embedItem = new ToolStripMenuItem("嵌入桌面")
        {
            Checked = true // 默认开启
        };
        embedItem.Click += (s, e) =>
        {
            embedItem.Checked = !embedItem.Checked;
            EmbedDesktopChanged?.Invoke(this, embedItem.Checked);
        };
        _contextMenu.Items.Add(embedItem);

        _contextMenu.Items.Add(new ToolStripSeparator());

        // 退出
        var exitItem = new ToolStripMenuItem("退出");
        exitItem.Click += (s, e) => ExitRequested?.Invoke(this, EventArgs.Empty);
        _contextMenu.Items.Add(exitItem);
    }

    private Icon LoadIcon()
    {
        try
        {
            // 尝试加载自定义图标
            var iconPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Assets", "app.ico");
            if (File.Exists(iconPath))
            {
                return new Icon(iconPath);
            }
        }
        catch
        {
            // 忽略错误
        }

        // 使用默认图标
        return SystemIcons.Application;
    }

    /// <summary>
    /// 显示气泡提示
    /// </summary>
    public void ShowBalloonTip(string title, string text, ToolTipIcon icon = ToolTipIcon.Info)
    {
        _notifyIcon?.ShowBalloonTip(3000, title, text, icon);
    }

    /// <summary>
    /// 更新托盘图标提示文本
    /// </summary>
    public void UpdateTooltip(string text)
    {
        if (_notifyIcon != null)
        {
            _notifyIcon.Text = text.Length > 63 ? text[..63] : text;
        }
    }

    public void Dispose()
    {
        _notifyIcon?.Dispose();
        _contextMenu?.Dispose();
    }
}
```

### 5.3 设置窗口

#### SettingsWindow.xaml

```xml
<Window x:Class="MiniNote.Views.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="设置"
        Width="360"
        Height="400"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ResizeMode="NoResize"
        WindowStartupLocation="CenterOwner"
        MouseLeftButtonDown="Window_MouseLeftButtonDown">
    
    <Border CornerRadius="8"
            Background="#F0202020"
            BorderBrush="#40FFFFFF"
            BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="40"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- 标题栏 -->
            <Border Grid.Row="0"
                    Background="#30FFFFFF"
                    CornerRadius="8,8,0,0">
                <Grid>
                    <TextBlock Text="设置"
                               Foreground="White"
                               FontWeight="SemiBold"
                               FontSize="14"
                               VerticalAlignment="Center"
                               Margin="16,0,0,0"/>
                    
                    <Button Content="&#xE711;"
                            FontFamily="Segoe MDL2 Assets"
                            HorizontalAlignment="Right"
                            Margin="0,0,8,0"
                            Style="{StaticResource TitleBarButtonStyle}"
                            Click="CloseButton_Click"/>
                </Grid>
            </Border>
            
            <!-- 设置内容 -->
            <ScrollViewer Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          Margin="16">
                <StackPanel>
                    <!-- 常规设置 -->
                    <TextBlock Text="常规"
                               Foreground="#80FFFFFF"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Margin="0,0,0,12"/>
                    
                    <Border Background="#20FFFFFF"
                            CornerRadius="6"
                            Padding="12"
                            Margin="0,0,0,16">
                        <StackPanel>
                            <!-- 开机自启 -->
                            <Grid Margin="0,0,0,12">
                                <TextBlock Text="开机自启动"
                                           Foreground="White"
                                           VerticalAlignment="Center"/>
                                <ToggleButton x:Name="TglAutoStart"
                                              HorizontalAlignment="Right"
                                              Style="{StaticResource ToggleSwitchStyle}"
                                              Checked="TglAutoStart_Changed"
                                              Unchecked="TglAutoStart_Changed"/>
                            </Grid>
                            
                            <!-- 嵌入桌面 -->
                            <Grid Margin="0,0,0,12">
                                <TextBlock Text="嵌入桌面（避免 Win+D）"
                                           Foreground="White"
                                           VerticalAlignment="Center"/>
                                <ToggleButton x:Name="TglEmbedDesktop"
                                              HorizontalAlignment="Right"
                                              Style="{StaticResource ToggleSwitchStyle}"
                                              Checked="TglEmbedDesktop_Changed"
                                              Unchecked="TglEmbedDesktop_Changed"/>
                            </Grid>
                            
                            <!-- 透明度 -->
                            <Grid>
                                <TextBlock Text="窗口透明度"
                                           Foreground="White"
                                           VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal"
                                            HorizontalAlignment="Right">
                                    <Slider x:Name="SldOpacity"
                                            Width="120"
                                            Minimum="0.3"
                                            Maximum="1.0"
                                            Value="0.85"
                                            VerticalAlignment="Center"
                                            ValueChanged="SldOpacity_ValueChanged"/>
                                    <TextBlock Text="{Binding Value, ElementName=SldOpacity, StringFormat={}{0:P0}}"
                                               Foreground="#80FFFFFF"
                                               Width="40"
                                               TextAlignment="Right"
                                               VerticalAlignment="Center"
                                               Margin="8,0,0,0"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </Border>
                    
                    <!-- 外观设置 -->
                    <TextBlock Text="外观"
                               Foreground="#80FFFFFF"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Margin="0,0,0,12"/>
                    
                    <Border Background="#20FFFFFF"
                            CornerRadius="6"
                            Padding="12"
                            Margin="0,0,0,16">
                        <StackPanel>
                            <!-- 深色模式 -->
                            <Grid>
                                <TextBlock Text="深色模式"
                                           Foreground="White"
                                           VerticalAlignment="Center"/>
                                <ToggleButton x:Name="TglDarkMode"
                                              IsChecked="True"
                                              HorizontalAlignment="Right"
                                              Style="{StaticResource ToggleSwitchStyle}"/>
                            </Grid>
                        </StackPanel>
                    </Border>
                    
                    <!-- 关于 -->
                    <TextBlock Text="关于"
                               Foreground="#80FFFFFF"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Margin="0,0,0,12"/>
                    
                    <Border Background="#20FFFFFF"
                            CornerRadius="6"
                            Padding="12">
                        <StackPanel>
                            <TextBlock Text="MiniNote"
                                       Foreground="White"
                                       FontSize="16"
                                       FontWeight="SemiBold"/>
                            <TextBlock Text="版本 1.0.0"
                                       Foreground="#80FFFFFF"
                                       FontSize="12"
                                       Margin="0,4,0,0"/>
                            <TextBlock Text="一款简洁的桌面待办工具"
                                       Foreground="#60FFFFFF"
                                       FontSize="11"
                                       Margin="0,8,0,0"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Border>
</Window>
```

### 5.4 开关按钮样式

添加到 App.xaml：

```xml
<!-- 开关按钮样式 -->
<Style x:Key="ToggleSwitchStyle" TargetType="ToggleButton">
    <Setter Property="Width" Value="44"/>
    <Setter Property="Height" Value="22"/>
    <Setter Property="Template">
        <Setter.Value>
            <ControlTemplate TargetType="ToggleButton">
                <Border x:Name="border"
                        Background="#40FFFFFF"
                        CornerRadius="11"
                        BorderThickness="0">
                    <Ellipse x:Name="thumb"
                             Width="18"
                             Height="18"
                             Fill="White"
                             HorizontalAlignment="Left"
                             Margin="2,0,0,0"/>
                </Border>
                <ControlTemplate.Triggers>
                    <Trigger Property="IsChecked" Value="True">
                        <Setter TargetName="border" Property="Background" Value="#007ACC"/>
                        <Setter TargetName="thumb" Property="HorizontalAlignment" Value="Right"/>
                        <Setter TargetName="thumb" Property="Margin" Value="0,0,2,0"/>
                    </Trigger>
                </ControlTemplate.Triggers>
            </ControlTemplate>
        </Setter.Value>
    </Setter>
</Style>
```

### 5.5 动画效果

#### 添加动画资源到 App.xaml

```xml
<!-- 淡入动画 -->
<Storyboard x:Key="FadeInAnimation">
    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                     From="0" To="1"
                     Duration="0:0:0.2"/>
</Storyboard>

<!-- 淡出动画 -->
<Storyboard x:Key="FadeOutAnimation">
    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                     From="1" To="0"
                     Duration="0:0:0.2"/>
</Storyboard>

<!-- 滑入动画 -->
<Storyboard x:Key="SlideInAnimation">
    <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)"
                     From="-20" To="0"
                     Duration="0:0:0.3">
        <DoubleAnimation.EasingFunction>
            <QuadraticEase EasingMode="EaseOut"/>
        </DoubleAnimation.EasingFunction>
    </DoubleAnimation>
    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                     From="0" To="1"
                     Duration="0:0:0.3"/>
</Storyboard>

<!-- 待办项添加动画样式 -->
<Style x:Key="AnimatedTodoItemStyle" TargetType="Border">
    <Setter Property="RenderTransform">
        <Setter.Value>
            <TranslateTransform/>
        </Setter.Value>
    </Setter>
    <Style.Triggers>
        <EventTrigger RoutedEvent="Loaded">
            <BeginStoryboard Storyboard="{StaticResource SlideInAnimation}"/>
        </EventTrigger>
    </Style.Triggers>
</Style>
```

### 5.6 更新 MainWindow 集成所有服务

#### MainWindow.xaml.cs 完整更新

```csharp
using System;
using System.Windows;
using System.Windows.Input;
using MiniNote.Helpers;
using MiniNote.Models;
using MiniNote.Services;
using MiniNote.ViewModels;

namespace MiniNote;

public partial class MainWindow : Window
{
    private readonly DesktopEmbedService _embedService;
    private readonly DatabaseService _dbService;
    private readonly NotificationService _notificationService;
    private readonly TrayIconService _trayService;
    private readonly MainViewModel _viewModel;
    private AppSettings _settings = null!;

    public MainWindow()
    {
        InitializeComponent();

        _dbService = new DatabaseService();
        _embedService = new DesktopEmbedService();
        _notificationService = new NotificationService(_dbService);
        _trayService = new TrayIconService();
        _viewModel = new MainViewModel();

        DataContext = _viewModel;

        InitializeTrayIcon();
    }

    private void InitializeTrayIcon()
    {
        _trayService.Initialize();
        _trayService.ShowWindowRequested += (s, e) =>
        {
            Show();
            Activate();
        };
        _trayService.ExitRequested += (s, e) =>
        {
            _trayService.Dispose();
            Application.Current.Shutdown();
        };
        _trayService.EmbedDesktopChanged += async (s, embed) =>
        {
            if (embed)
            {
                _embedService.EmbedToDesktop(this);
            }
            else
            {
                _embedService.DetachFromDesktop(this);
            }
            _settings.EmbedDesktop = embed;
            await _dbService.SaveSettingsAsync(_settings);
        };
    }

    private async void Window_Loaded(object sender, RoutedEventArgs e)
    {
        // 加载设置
        _settings = await _dbService.GetSettingsAsync();

        // 应用窗口位置和大小
        Left = _settings.WindowX;
        Top = _settings.WindowY;
        Width = _settings.WindowWidth;
        Height = _settings.WindowHeight;
        Opacity = _settings.Opacity;

        // 启用磨砂效果
        AcrylicHelper.EnableAcrylic(this);
        AcrylicHelper.SetDarkMode(this, true);

        // 嵌入桌面
        if (_settings.EmbedDesktop)
        {
            _embedService.EmbedToDesktop(this);
        }

        // 启动提醒服务
        _notificationService.StartReminderService();

        // 加载待办数据
        await _viewModel.InitializeAsync();

        // 更新托盘提示
        UpdateTrayTooltip();
    }

    private async void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)
    {
        // 保存窗口位置和大小
        _settings.WindowX = Left;
        _settings.WindowY = Top;
        _settings.WindowWidth = Width;
        _settings.WindowHeight = Height;
        await _dbService.SaveSettingsAsync(_settings);

        // 停止提醒服务
        _notificationService.StopReminderService();

        // 取消桌面嵌入
        _embedService.DetachFromDesktop(this);
    }

    private void Window_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
    {
        if (e.LeftButton == MouseButtonState.Pressed)
        {
            DragMove();
        }
    }

    private void BtnSettings_Click(object sender, RoutedEventArgs e)
    {
        var settingsWindow = new Views.SettingsWindow
        {
            Owner = this
        };
        settingsWindow.SettingsChanged += async (s, settings) =>
        {
            _settings = settings;
            Opacity = settings.Opacity;
            await _dbService.SaveSettingsAsync(settings);
        };
        settingsWindow.ShowDialog();
    }

    private void BtnMinimize_Click(object sender, RoutedEventArgs e)
    {
        Hide();
        _trayService.ShowBalloonTip("MiniNote", "程序已最小化到托盘");
    }

    private void UpdateTrayTooltip()
    {
        var pending = _viewModel.TotalCount - _viewModel.CompletedCount;
        _trayService.UpdateTooltip($"MiniNote - {pending} 项待办");
    }
}
```

## 验收标准

- [ ] 能够设置开机自启动（待实现）
- [x] 系统托盘显示应用图标
- [x] 右键托盘图标显示菜单
- [x] 双击托盘图标打开主窗口
- [ ] 设置窗口能正常打开和关闭（待实现）
- [ ] 透明度滑块能实时调整窗口透明度（待实现）
- [ ] 添加待办项时有动画效果（待实现）
- [ ] 关闭窗口时最小化到托盘（待实现，目前是直接退出）

## 注意事项

1. 系统托盘需要添加 `System.Windows.Forms` 和 `System.Drawing.Common` 引用
2. 开机自启通过注册表实现，不需要管理员权限
3. 托盘图标需要 .ico 格式的图标文件
4. 最小化到托盘而不是关闭程序，关闭需要从托盘菜单退出

## 项目配置更新

需要在 csproj 中添加以下引用：

```xml
<ItemGroup>
    <PackageReference Include="System.Drawing.Common" Version="10.0.0" />
    <FrameworkReference Include="Microsoft.WindowsDesktop.App.WindowsForms" />
</ItemGroup>
```
