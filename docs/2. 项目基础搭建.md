# 阶段一：项目基础搭建

## 目标

搭建 WPF 项目基础结构，配置必要的依赖包，设计数据模型。

## 任务清单

### 1.1 创建项目结构

- [ ] 创建解决方案 `MiniNote.sln`
- [ ] 创建 WPF 项目 `MiniNote.csproj`
- [ ] 创建项目文件夹结构

**命令：**
```bash
dotnet new sln -n MiniNote -o src
dotnet new wpf -n MiniNote -o src/MiniNote -f net10.0
dotnet sln src/MiniNote.sln add src/MiniNote/MiniNote.csproj
```

### 1.2 配置项目文件

**MiniNote.csproj 配置：**
```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net10.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWPF>true</UseWPF>
    <ApplicationIcon>Assets\app.ico</ApplicationIcon>
    <AssemblyName>MiniNote</AssemblyName>
    <RootNamespace>MiniNote</RootNamespace>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="10.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="10.0.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.2.2" />
    <PackageReference Include="Microsoft.Toolkit.Uwp.Notifications" Version="7.1.3" />
  </ItemGroup>

</Project>
```

### 1.3 创建数据模型

#### TodoItem.cs - 待办项实体

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace MiniNote.Models;

/// <summary>
/// 待办项实体
/// </summary>
public class TodoItem
{
    [Key]
    public int Id { get; set; }
    
    /// <summary>
    /// 待办内容
    /// </summary>
    [Required]
    [MaxLength(500)]
    public string Content { get; set; } = string.Empty;
    
    /// <summary>
    /// 是否完成
    /// </summary>
    public bool IsCompleted { get; set; }
    
    /// <summary>
    /// 优先级：0-低，1-中，2-高
    /// </summary>
    public int Priority { get; set; } = 1;
    
    /// <summary>
    /// 分类ID
    /// </summary>
    public int? CategoryId { get; set; }
    
    /// <summary>
    /// 分类导航属性
    /// </summary>
    public TodoCategory? Category { get; set; }
    
    /// <summary>
    /// 提醒时间
    /// </summary>
    public DateTime? ReminderTime { get; set; }
    
    /// <summary>
    /// 是否已提醒
    /// </summary>
    public bool IsReminded { get; set; }
    
    /// <summary>
    /// 创建时间
    /// </summary>
    public DateTime CreatedAt { get; set; } = DateTime.Now;
    
    /// <summary>
    /// 更新时间
    /// </summary>
    public DateTime UpdatedAt { get; set; } = DateTime.Now;
    
    /// <summary>
    /// 排序顺序
    /// </summary>
    public int SortOrder { get; set; }
}
```

#### TodoCategory.cs - 分类实体

```csharp
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;

namespace MiniNote.Models;

/// <summary>
/// 待办分类实体
/// </summary>
public class TodoCategory
{
    [Key]
    public int Id { get; set; }
    
    /// <summary>
    /// 分类名称
    /// </summary>
    [Required]
    [MaxLength(50)]
    public string Name { get; set; } = string.Empty;
    
    /// <summary>
    /// 分类颜色（十六进制）
    /// </summary>
    [MaxLength(7)]
    public string Color { get; set; } = "#007ACC";
    
    /// <summary>
    /// 排序顺序
    /// </summary>
    public int SortOrder { get; set; }
    
    /// <summary>
    /// 该分类下的待办项
    /// </summary>
    public ICollection<TodoItem> TodoItems { get; set; } = new List<TodoItem>();
}
```

#### AppSettings.cs - 应用设置实体

```csharp
using System.ComponentModel.DataAnnotations;

namespace MiniNote.Models;

/// <summary>
/// 应用设置实体
/// </summary>
public class AppSettings
{
    [Key]
    public int Id { get; set; }
    
    /// <summary>
    /// 窗口 X 坐标
    /// </summary>
    public double WindowX { get; set; } = 100;
    
    /// <summary>
    /// 窗口 Y 坐标
    /// </summary>
    public double WindowY { get; set; } = 100;
    
    /// <summary>
    /// 窗口宽度
    /// </summary>
    public double WindowWidth { get; set; } = 300;
    
    /// <summary>
    /// 窗口高度
    /// </summary>
    public double WindowHeight { get; set; } = 400;
    
    /// <summary>
    /// 是否开机自启
    /// </summary>
    public bool AutoStart { get; set; } = false;
    
    /// <summary>
    /// 是否嵌入桌面
    /// </summary>
    public bool EmbedDesktop { get; set; } = true;
    
    /// <summary>
    /// 透明度 (0.0 - 1.0)
    /// </summary>
    public double Opacity { get; set; } = 0.85;
}
```

### 1.4 创建数据库上下文

#### AppDbContext.cs

```csharp
using Microsoft.EntityFrameworkCore;
using MiniNote.Models;
using System;
using System.IO;

namespace MiniNote.Data;

public class AppDbContext : DbContext
{
    public DbSet<TodoItem> TodoItems { get; set; } = null!;
    public DbSet<TodoCategory> Categories { get; set; } = null!;
    public DbSet<AppSettings> Settings { get; set; } = null!;

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        var appDataPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
            "MiniNote"
        );
        
        if (!Directory.Exists(appDataPath))
        {
            Directory.CreateDirectory(appDataPath);
        }
        
        var dbPath = Path.Combine(appDataPath, "mininote.db");
        optionsBuilder.UseSqlite($"Data Source={dbPath}");
    }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        
        // 配置 TodoItem 与 Category 的关系
        modelBuilder.Entity<TodoItem>()
            .HasOne(t => t.Category)
            .WithMany(c => c.TodoItems)
            .HasForeignKey(t => t.CategoryId)
            .OnDelete(DeleteBehavior.SetNull);
        
        // 添加默认分类
        modelBuilder.Entity<TodoCategory>().HasData(
            new TodoCategory { Id = 1, Name = "默认", Color = "#007ACC", SortOrder = 0 }
        );
        
        // 添加默认设置
        modelBuilder.Entity<AppSettings>().HasData(
            new AppSettings { Id = 1 }
        );
    }
}
```

### 1.5 创建数据库服务

#### DatabaseService.cs

```csharp
using Microsoft.EntityFrameworkCore;
using MiniNote.Data;
using MiniNote.Models;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace MiniNote.Services;

public class DatabaseService
{
    private readonly AppDbContext _context;

    public DatabaseService()
    {
        _context = new AppDbContext();
        _context.Database.EnsureCreated();
    }

    #region TodoItem 操作

    public async Task<List<TodoItem>> GetAllTodosAsync()
    {
        return await _context.TodoItems
            .Include(t => t.Category)
            .OrderBy(t => t.IsCompleted)
            .ThenByDescending(t => t.Priority)
            .ThenBy(t => t.SortOrder)
            .ToListAsync();
    }

    public async Task<TodoItem?> GetTodoByIdAsync(int id)
    {
        return await _context.TodoItems
            .Include(t => t.Category)
            .FirstOrDefaultAsync(t => t.Id == id);
    }

    public async Task<TodoItem> AddTodoAsync(TodoItem todo)
    {
        _context.TodoItems.Add(todo);
        await _context.SaveChangesAsync();
        return todo;
    }

    public async Task UpdateTodoAsync(TodoItem todo)
    {
        todo.UpdatedAt = System.DateTime.Now;
        _context.TodoItems.Update(todo);
        await _context.SaveChangesAsync();
    }

    public async Task DeleteTodoAsync(int id)
    {
        var todo = await _context.TodoItems.FindAsync(id);
        if (todo != null)
        {
            _context.TodoItems.Remove(todo);
            await _context.SaveChangesAsync();
        }
    }

    #endregion

    #region Category 操作

    public async Task<List<TodoCategory>> GetAllCategoriesAsync()
    {
        return await _context.Categories
            .OrderBy(c => c.SortOrder)
            .ToListAsync();
    }

    public async Task<TodoCategory> AddCategoryAsync(TodoCategory category)
    {
        _context.Categories.Add(category);
        await _context.SaveChangesAsync();
        return category;
    }

    public async Task UpdateCategoryAsync(TodoCategory category)
    {
        _context.Categories.Update(category);
        await _context.SaveChangesAsync();
    }

    public async Task DeleteCategoryAsync(int id)
    {
        var category = await _context.Categories.FindAsync(id);
        if (category != null)
        {
            _context.Categories.Remove(category);
            await _context.SaveChangesAsync();
        }
    }

    #endregion

    #region Settings 操作

    public async Task<AppSettings> GetSettingsAsync()
    {
        return await _context.Settings.FirstOrDefaultAsync() 
               ?? new AppSettings();
    }

    public async Task SaveSettingsAsync(AppSettings settings)
    {
        var existing = await _context.Settings.FirstOrDefaultAsync();
        if (existing != null)
        {
            existing.WindowX = settings.WindowX;
            existing.WindowY = settings.WindowY;
            existing.WindowWidth = settings.WindowWidth;
            existing.WindowHeight = settings.WindowHeight;
            existing.AutoStart = settings.AutoStart;
            existing.EmbedDesktop = settings.EmbedDesktop;
            existing.Opacity = settings.Opacity;
        }
        else
        {
            _context.Settings.Add(settings);
        }
        await _context.SaveChangesAsync();
    }

    #endregion
}
```

## 验收标准

- [ ] 项目能够成功编译
- [ ] 运行后能够自动创建 SQLite 数据库
- [ ] 数据库包含正确的表结构
- [ ] 能够正常进行 CRUD 操作

## 注意事项

1. 数据库文件存储在 `%LocalAppData%\MiniNote\mininote.db`
2. 首次运行会自动创建数据库和默认数据
3. 使用 EF Core 的 `EnsureCreated()` 方法简化数据库初始化
